#!/bin/sh
#
# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2020 Marvell
# Copyright (c) 2020 Nokia
#
# Script to setup interfaces used for running application on linux-dpdk.
#
# For linux-dpdk the default behavior is to create two pcap interfaces which
# use udp64.pcap file to inject traffic. An output pcap file is generated by
# the second interface.
#
# Network set-up
# IF0 <---> IF1

PCAP_IN=`find . ${TEST_DIR} $(dirname $0) -name udp64.pcap -print -quit`
IF0=0
IF1=1

export ODP_PLATFORM_PARAMS="--no-pci \
--vdev net_pcap0,rx_pcap=${PCAP_IN},tx_pcap=/dev/null \
--vdev net_pcap1,rx_pcap=${PCAP_IN},tx_pcap=pcapout.pcap"

echo "Using PCAP_IN = ${PCAP_IN}"

if [ "$0" = "$BASH_SOURCE" ]; then
	echo "Error: Platform specific env file has to be sourced."
fi

validate_result()
{
	# DPDK PCAP vdev may add some extra data to the end of the output file
	# in process mode if the interface is started after fork.
	if [ `stat -c %s pcapout.pcap` -lt `stat -c %s  ${PCAP_IN}` ]; then
		echo "File sizes disagree"
		exit 1
	fi

	rm -f pcapout.pcap
}

setup_interfaces()
{
	echo "pktio: setting up test interfaces $IF0, $IF1."
	return 0
}

cleanup_interfaces()
{
	echo "pktio: cleaning up test interfaces $IF0, $IF1."
	return 0
}
